<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loading-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-60">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
    </div>
    <div x-data="{ sidebarOpen: false, currentSection: 'personas' }" class="flex h-screen bg-gray-200">
        <!-- Overlay para cerrar el sidebar en móviles -->
        <div @click="sidebarOpen = false" x-show="sidebarOpen" class="fixed inset-0 z-20 transition-opacity bg-black opacity-50 lg:hidden"></div>

        <!-- Sidebar -->
        <div :class="sidebarOpen ? 'translate-x-0 ease-out' : '-translate-x-full ease-in'" class="fixed text-white inset-y-0 left-0 z-30 w-64 overflow-y-auto transition duration-300 transform bg-gray-800 lg:translate-x-0 lg:static lg:inset-0">
            <nav class="mt-5 space-y-2">
                <a @click="currentSection = 'personas'; sidebarOpen = false" href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">
                    Gestión de Personas
                </a>
                <a @click="currentSection = 'usuarios'; sidebarOpen = false" href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">
                    Gestión de Usuarios
                </a>
                <a @click="currentSection = 'asistencias'; sidebarOpen = false" href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">
                    Asistencias
                </a>
                <a @click="openQRScanner(); sidebarOpen = false" href="#" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">
                    Escanear QR
                </a>
            </nav>
            <div class="absolute bottom-0 w-full p-4">
                <button id="logoutButton" class="w-full bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 transition duration-200">Cerrar Sesión</button>
            </div>
        </div>

        <!-- Content area -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-4 bg-white border-b">
                <button @click="sidebarOpen = !sidebarOpen" class="text-gray-500 focus:outline-none lg:hidden">
                    <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <h1 class="text-xl font-semibold">Dashboard Evento</h1>
                <div></div> <!-- Placeholder para alineación -->
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-200 p-4">
                <!-- Gestión de Personas -->
                <div x-show="currentSection === 'personas'">
                    <h2 class="text-2xl font-semibold mb-4">Gestión de Personas</h2>
                    <div class="mb-4 flex flex-col sm:flex-row justify-between items-center">
                        <input type="text" id="personaSearch" placeholder="Buscar personas..." class="w-full sm:w-auto px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 mb-2 sm:mb-0">
                        <button id="addPersonaBtn" class="w-full sm:w-auto bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition duration-200">Agregar Persona</button>
                        <br>
                        <button id="generarExcelPersonas" class="w-full sm:w-auto bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition duration-200">Generar Excel</button>
                        <br>
                        <button id="enviarQRTodos" class="w-full sm:w-auto bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition duration-200">Enviar QR a Todos</button>
                        <br>
                        <button id="enviarCertificadoTodos" class="w-full sm:w-auto bg-purple-500 text-white py-2 px-4 rounded hover:bg-purple-600 transition duration-200">Enviar Certificado a Todos</button>
                    </div>
                    <div id="personasList" class="space-y-4">
                        <!-- La lista de personas se cargará aquí -->
                    </div>
                </div>
                <!--Seccion de asistencias-->
                <div x-show="currentSection === 'asistencias'">
                    <h2 class="text-2xl font-semibold mb-4">Asistencias</h2>
                    <div class="mb-4 flex flex-col sm:flex-row justify-between items-center">
                        <input type="text" id="asistenciaSearch" placeholder="Buscar asistencias..." class="w-full sm:w-auto px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 mb-2 sm:mb-0">
                        <select id="filtroAsistencias" class="w-full sm:w-auto px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 mb-2 sm:mb-0">
                            <option value="todas">Todas las asistencias</option>
                            <option value="1">1 asistencia</option>
                            <option value="2">2 asistencias</option>
                            <option value="3">3 asistencias</option>
                            <option value="4">4 o más asistencias</option>
                            <option value="sin_asistencia">Sin asistencias</option>
                        </select>
                        <button id="registrarAsistenciaManual" class="w-full sm:w-auto bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition duration-200">Registrar Asistencia</button>
                        <br>
                        <button id="convertirExcel" class="w-full sm:w-auto bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition duration-200">Generar Excel</button>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table class="min-w-full">
                            <thead class="bg-blue-600 text-white">
                                <tr>
                                    <th class="py-3 px-4 text-left">Nombre Completo</th>
                                    <th class="py-3 px-4 text-left">Registro</th>
                                    <th class="py-3 px-4 text-left">Correo</th>
                                    <th class="py-3 px-4 text-left">Carrera</th>
                                    <th class="py-3 px-4 text-left">Celular</th>
                                    <th class="py-3 px-4 text-left">Fecha/Hora de Asistencia</th>
                                </tr>
                            </thead>
                            <tbody id="asistenciasList">
                                <!-- La lista de asistencias se cargará aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Gestión de Usuarios -->
                <div x-show="currentSection === 'usuarios'">
                    <h2 class="text-2xl font-semibold mb-4">Gestión de Usuarios</h2>
                    <div class="mb-4 flex flex-col sm:flex-row justify-between items-center">
                        <input type="text" id="usuarioSearch" placeholder="Buscar usuarios..." class="w-full sm:w-auto px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 mb-2 sm:mb-0">
                        <button id="addUsuarioBtn" class="w-full sm:w-auto bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition duration-200">Agregar Usuario</button>
                    </div>
                    <div id="usuariosList" class="space-y-4">
                        <!-- La lista de usuarios se cargará aquí -->
                    </div>
                </div>
    <div id="usuarioModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 id="usuarioModalTitle" class="text-lg font-semibold mb-4">Agregar Usuario</h3>
            <form id="usuarioForm">
                <input type="hidden" id="usuarioId">
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Nombre de usuario:</label>
                    <input type="text" id="username" name="username" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Contraseña:</label>
                    <input type="password" id="password" name="password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                </div>
                <div class="flex justify-end">
                    <button type="button" onclick="cerrarModalUsuario()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded mr-2 hover:bg-gray-400 transition duration-200">Cancelar</button>
                    <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition duration-200">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <!--- Modal para agregar/editar persona (actualizado) -->
    <div id="personaModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 id="modalTitle" class="text-lg font-semibold mb-4">Agregar Persona</h3>
            <form id="personaForm">
                <input type="hidden" id="personaId">
                <div class="mb-4">
                    <label for="nombreCompleto" class="block text-gray-700 text-sm font-bold mb-2">Nombre Completo:</label>
                    <input type="text" id="nombreCompleto" name="nombreCompleto" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="correo" class="block text-gray-700 text-sm font-bold mb-2">Correo:</label>
                    <input type="email" id="correo" name="correo" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="celular" class="block text-gray-700 text-sm font-bold mb-2">Celular:</label>
                    <input type="tel" id="celular" name="celular" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="carrera" class="block text-gray-700 text-sm font-bold mb-2">Carrera:</label>
                    <input type="text" id="carrera" name="carrera" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="registro" class="block text-gray-700 text-sm font-bold mb-2">Registro:</label>
                    <input type="text" id="registro" name="registro" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                </div>
                <div class="flex justify-end">
                    <button type="button" id="cancelarBtn" onclick="cerrarModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded mr-2 hover:bg-gray-400 transition duration-200">Cancelar</button>
                    <button type="button" id="guardarBtn" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition duration-200 mr-2">Guardar</button>
                    <button type="button" id="guardarEnviarBtn" class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition duration-200">Guardar y Enviar Correo</button>
                </div>
            </form>
        </div>
    </div>
    <div id="qrModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-semibold mb-4">Código QR</h3>
            <div id="qrContainer" class="flex flex-col items-center"></div>
            <div class="mt-4 flex justify-end">
                <button onclick="cerrarModalQR()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400 transition duration-200">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="qrScannerModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-semibold mb-4">Escanear Código QR</h3>
            <div id="qrReader" class="mb-4">
                <video id="qrVideo" class="w-full"></video>
            </div>
            <div id="personaDetails" class="mb-4 hidden">
                <h4 class="font-semibold mb-2 text-xl">Detalles de la Persona</h4>
                <div class="bg-gray-100 p-4 rounded-lg">
                    <p class="mb-2"><strong class="text-blue-600">Nombre Completo:</strong> <span id="personaNombreCompleto" class="ml-2"></span></p>
                    <p class="mb-2"><strong class="text-blue-600">Correo:</strong> <span id="personaRegistro" class="ml-2"></span></p>
                    <p class="mb-2"><strong class="text-blue-600">Correo:</strong> <span id="personaCorreo" class="ml-2"></span></p>
                    <p class="mb-2"><strong class="text-blue-600">Celular:</strong> <span id="personaCelular" class="ml-2"></span></p>
                    <p class="mb-2"><strong class="text-blue-600">Institución:</strong> <span id="personaCarrera" class="ml-2"></span></p>
                    <p class="mb-2"><strong class="text-blue-600">Última Asistencia:</strong> <span id="personaUltimaAsistencia" class="ml-2"></span></p>
                </div>
            </div>
            <div class="flex justify-end mt-4">
                <button id="registrarAsistenciaBtn" class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition duration-200 mr-2 hidden">Registrar Asistencia</button>
                <button onclick="closeQRScanner()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400 transition duration-200">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="registrarAsistenciaModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-semibold mb-4">Registrar Asistencia</h3>
            <input type="text" id="personaSearchInput" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 mb-4" placeholder="Buscar persona...">
            <div id="personaListContainer" class="max-h-60 overflow-y-auto mb-4">
                <ul id="personaSearchResults"></ul>
            </div>
            <div class="flex justify-end">
                <button onclick="cerrarModalRegistroAsistencia()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400 transition duration-200 mr-2">Cancelar</button>
                <button onclick="registrarAsistenciasMultiples()" class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition duration-200">Registrar Seleccionados</button>
            </div>
        </div>
    </div>
    <div id="certificadoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-3/4 max-w-4xl shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-semibold mb-4">Certificado</h3>
            <div id="certificadoDetails" class="mb-4">
                <p><strong>Nombre:</strong> <span id="certNombrePersona"></span></p>
                <p><strong>Nombre del Archivo:</strong> <span id="certNombreArchivo"></span></p>
                <p><strong>Extensión:</strong> <span id="certExtension"></span></p>
            </div>
            <div id="certificadoPreview" class="mb-4 h-96 border rounded-lg overflow-hidden">
                <!-- La vista previa del certificado se cargará aquí -->
            </div>
            <div class="flex justify-end">
                <button id="descargarCertificadoBtn" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition duration-200 mr-2">Descargar Certificado</button>
                <button onclick="cerrarModalCertificado()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400 transition duration-200">Cerrar</button>
            </div>
        </div>
    </div>
    <script>
        
        let todasLasAsistencias = [];
        let personasSeleccionadas = new Set();
        function getCurrentDateTime() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000; // offset en milisegundos
            const localISOTime = (new Date(now - offset)).toISOString().slice(0, -1);
            return localISOTime;
        
        }
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        // Función para ocultar el overlay de carga
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        function showAlert(title, text, icon) {
            Swal.fire({
                title: title,
                text: text,
                icon: icon,
                confirmButtonColor: '#3085d6',
                confirmButtonText: 'OK'
            });
        }
         let personaActual = null;
         function openQRScanner() {
    const qrScannerModal = document.getElementById('qrScannerModal');
    const qrReader = document.getElementById('qrReader');
    const personaDetails = document.getElementById('personaDetails');
    const saveButton = document.getElementById('saveButton');

    if (!qrScannerModal || !qrReader || !personaDetails) {
        console.error('No se encontraron uno o más elementos necesarios');
        return;
    }
    qrScannerModal.classList.remove('hidden');
    qrReader.classList.remove('hidden');
    personaDetails.classList.add('hidden');
    
    if (saveButton) {
        saveButton.classList.add('hidden');
    }
    startQRScanner();
}

        function closeQRScanner() {
            document.getElementById('qrScannerModal').classList.add('hidden');
            stopQRScanner();
        }
        let videoStream;

        function startQRScanner() {
    if(!verificarSesion()) return;
    const video = document.getElementById('qrVideo');
    
    // Intentar primero con la cámara trasera
    navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: { exact: "environment" } } 
    })
    .then(setupStream)
    .catch(() => {
        // Si falla, intentar con cualquier cámara disponible
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(setupStream)
            .catch(handleError);
    });

    function setupStream(stream) {
        videoStream = stream;
        video.srcObject = stream;
        video.setAttribute("playsinline", true); // Importante para iOS
        video.play();
        requestAnimationFrame(tick);
    }

    function handleError(error) {
        console.error("Error al acceder a la cámara: ", error);
        showAlert('Error', 'No se pudo acceder a la cámara. Por favor, asegúrese de que su dispositivo tiene una cámara y que ha dado permiso para usarla.', 'error');
    }
}
        function stopQRScanner() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
        }
        function tick() {
            const video = document.getElementById('qrVideo');

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement("canvas");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    console.log("Código QR detectado", code.data);
                    handleQRCode(code.data);
                    stopQRScanner();
                } else {
                    requestAnimationFrame(tick);
                }
            } else {
                requestAnimationFrame(tick);
            }
        }

        async function handleQRCode(qrData) {
    try {
        showLoading();
        const response = await fetch(`https://localhost:7016/api/Personas/ObtenerPersonaPorCodigoUnico?codigoUnico=${qrData}`);
        hideLoading();
        
        if (response.ok) {
            const persona = await response.json();
            if (persona.scaneado) {
                showAlert('Error', 'Este QR ya ha sido escaneado y la asistencia ya ha sido registrada.', 'error');
                startQRScanner(); // Reinicia el escáner para el próximo código
            } else {
                mostrarDetallesPersona(persona);
            }
        } else {
            showAlert('Error', 'No se encontró la persona asociada a este código QR', 'error');
            startQRScanner();
        }
    } catch (error) {
        hideLoading();
        console.error('Error al procesar el código QR:', error);
        showAlert('Error', 'Hubo un problema al procesar el código QR', 'error');
        startQRScanner();
    }
}
function showAlert(title, text, icon) {
    Swal.fire({
        title: title,
        text: text,
        icon: icon,
        confirmButtonColor: '#3085d6',
        confirmButtonText: 'OK'
    });
}
function mostrarDetallesPersona(persona) {
    document.getElementById('personaNombreCompleto').textContent = persona.nombreCompleto;
    document.getElementById('personaRegistro').textContent = persona.registro;
    document.getElementById('personaCorreo').textContent = persona.correo;
    document.getElementById('personaCelular').textContent = persona.celular;
    document.getElementById('personaCarrera').textContent = persona.carrera;

    fetch(`https://localhost:7016/api/Asistencia/ObtenerUltimaAsistenciaPorPersonaId?idPersona=${persona.id}`)
        .then(response => response.json())
        .then(data => {
            if (data && data.fecha) {
                document.getElementById('personaUltimaAsistencia').textContent = new Date(data.fecha).toLocaleString();
            } else {
                document.getElementById('personaUltimaAsistencia').textContent = 'Sin asistencias registradas';
            }
        })
        .catch(error => {
            document.getElementById('personaUltimaAsistencia').textContent = 'Error al obtener la última asistencia';
        });

    // Eliminar botón existente si lo hay
    const existingButton = document.getElementById('registrarAsistenciaBtn');
    if (existingButton) {
        existingButton.remove();
    }

    // Agregar botón de registrar asistencia
    const registrarAsistenciaBtn = document.createElement('button');
    registrarAsistenciaBtn.id = 'registrarAsistenciaBtn';
    registrarAsistenciaBtn.textContent = 'Registrar Asistencia';
    registrarAsistenciaBtn.className = 'bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition duration-200 mt-4 mx-auto block';
    registrarAsistenciaBtn.onclick = () => registrarAsistencia(persona.id);
    
    const personaDetails = document.getElementById('personaDetails');
    if (personaDetails) {
        personaDetails.appendChild(registrarAsistenciaBtn);
        personaDetails.classList.remove('hidden');
    } else {
        console.error('El elemento personaDetails no se encontró');
    }

    const qrReader = document.getElementById('qrReader');
    if (qrReader) {
        qrReader.classList.add('hidden');
    } else {
        console.error('El elemento qrReader no se encontró');
    }

    const saveButton = document.getElementById('saveButton');
    if (saveButton) {
        saveButton.classList.add('hidden');
    }
}
async function subirCertificado(id) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pdf,.doc,.docx';

    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('certificado', file);
        formData.append('IdPersona', id);
        formData.append('NombreArchivo', file.name);
        formData.append('Extension', file.name.split('.').pop());

        try {
            showLoading();
            const response = await fetch('https://localhost:7016/api/Certificado/SubirCertificado', {
                method: 'POST',
                body: formData
            });

            hideLoading();
            if (response.ok) {
                showAlert('Éxito', 'Certificado subido correctamente', 'success');
            } else {
                const errorText = await response.text();
                showAlert('Error', `No se pudo subir el certificado: ${errorText}`, 'error');
            }
        } catch (error) {
            hideLoading();
            console.error('Error:', error);
            showAlert('Error', 'Hubo un problema al conectar con el servidor', 'error');
        }
    };

    input.click();
}
async function guardarCambiosPersona() {
    if (!personaActual) return;
    showLoading();
    try {
        const response = await fetch('https://localhost:7016/api/Personas/ActualizarPersona', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(personaActual)
        });

        hideLoading();
        if (response.ok) {
            showAlert('Éxito', 'Cambios guardados correctamente', 'success');
            document.getElementById('qrReader').classList.remove('hidden');
            document.getElementById('personaDetails').classList.add('hidden');
            document.getElementById('saveButton').classList.add('hidden');
            startQRScanner(); // Reiniciar el escaneo
            cargarPersonas();
        } else {
            showAlert('Error', 'No se pudieron guardar los cambios', 'error');
            startQRScanner();
        }
    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        showAlert('Error', 'Hubo un problema al conectar con el servidor', 'error');
        startQRScanner();
    }
}
        function filtrarPersonas(searchTerm) {
            const personas = document.querySelectorAll('#personasList > div');
            personas.forEach(persona => {
            const texto = persona.textContent.toLowerCase();
            if (texto.includes(searchTerm.toLowerCase())) {
                persona.style.display = '';
            } else {
            persona.style.display = 'none';
            }});
        }
        function filtrarAsistencias(searchTerm) {
        const asistencias = document.querySelectorAll('#asistenciasList > div');
        asistencias.forEach(asistencia => {
        const texto = asistencia.textContent.toLowerCase();
        if (texto.includes(searchTerm.toLowerCase())) {
            asistencia.style.display = '';
        } else {
            asistencia.style.display = 'none';
        }
    });
}
        function filtrarUsuarios(searchTerm) {
        const usuarios = document.querySelectorAll('#usuariosList > div');
        usuarios.forEach(usuario => {
        const texto = usuario.textContent.toLowerCase();
        if (texto.includes(searchTerm.toLowerCase())) {
            usuario.style.display = '';
        } else {
            usuario.style.display = 'none';
        }
    });
}
async function cargarAsistencias() {
    if (!verificarSesion()) return;
    try {
        const usuario = JSON.parse(localStorage.getItem('user'));
        const response = await fetch('https://localhost:7016/api/Asistencia/ObtenerListaDeAsistencias', {
            headers: {
                'UserId': usuario.id,
                'Username': usuario.username
            }
        });
        if (response.ok) {
            todasLasAsistencias = await response.json();
            mostrarAsistencias(todasLasAsistencias);
        } else {
            console.error('Error al cargar asistencias');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
function contarAsistenciasPorPersona(asistencias) {
    const conteo = {};
    asistencias.forEach(asistencia => {
        conteo[asistencia.nombreCompleto] = (conteo[asistencia.nombreCompleto] || 0) + 1;
    });
    return conteo;
}
function mostrarAsistencias(asistencias) {
    const listaHTML = asistencias.map(asistencia => `
        <tr class="border-b">
            <td class="py-3 px-4">${asistencia.nombreCompleto}</td>
            <td class="py-3 px-4">${asistencia.registro}</td>
            <td class="py-3 px-4">${asistencia.correo}</td>
            <td class="py-3 px-4">${asistencia.carrera}</td>
            <td class="py-3 px-4">${asistencia.celular}</td>
            <td class="py-3 px-4">${asistencia.fecha === 'Sin asistencia registrada' ? asistencia.fecha : new Date(asistencia.fecha).toLocaleString()}</td>
            ${asistencia.fecha !== 'Sin asistencia registrada' ? `
            <td class="py-3 px-4">
                <button onclick="eliminarAsistencia(${asistencia.id})" class="bg-red-500 text-white py-1 px-2 rounded hover:bg-red-600 transition duration-200">Eliminar</button>
            </td>
            ` : '<td></td>'}
        </tr>
    `).join('');
    document.getElementById('asistenciasList').innerHTML = listaHTML;
}
async function eliminarAsistencia(id) {
    const result = await Swal.fire({
        title: '¿Está seguro?',
        text: "Esta acción no se puede deshacer",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        showLoading();
        try {
            const response = await fetch(`https://localhost:7016/api/Asistencia/EliminarAsistencia?id=${id}`, { method: 'DELETE' });
            hideLoading();
            if (response.ok) {
                showAlert('Eliminado', 'La asistencia ha sido eliminada correctamente', 'success');
                await cargarAsistencias();
            } else {
                showAlert('Error', 'No se pudo eliminar la asistencia', 'error');
            }
        } catch (error) {
            hideLoading();
            showAlert('Error', 'Hubo un problema al conectar con el servidor', 'error');
        }
    }
}
async function filtrarAsistencias() {
    const searchTerm = document.getElementById('asistenciaSearch').value.toLowerCase();
    const filtro = document.getElementById('filtroAsistencias').value;
    
    let asistenciasFiltradas;

    if (filtro === 'sin_asistencia') {
        try {
            const response = await fetch('https://localhost:7016/api/Asistencia/ObtenerPersonasSinAsistencias');
            if (response.ok) {
                const personasSinAsistencia = await response.json();
                asistenciasFiltradas = personasSinAsistencia.map(persona => ({
                    nombreCompleto: persona.nombreCompleto,
                    institucion: persona.institucion,
                    celular: persona.celular,
                    fecha: 'Sin asistencia registrada'
                }));
            } else {
                console.error('Error al obtener personas sin asistencias');
                asistenciasFiltradas = [];
            }
        } catch (error) {
            console.error('Error:', error);
            asistenciasFiltradas = [];
        }
    } else {
        const conteo = contarAsistenciasPorPersona(todasLasAsistencias);
        asistenciasFiltradas = todasLasAsistencias.filter(asistencia => {
            const cumpleFiltro = filtro === 'todas' || 
                                 (filtro === '4' && conteo[asistencia.nombreCompleto] >= 4) ||
                                 (conteo[asistencia.nombreCompleto] === parseInt(filtro));
            const cumpleBusqueda = asistencia.nombreCompleto.toLowerCase().includes(searchTerm) ||
                                   asistencia.institucion.toLowerCase().includes(searchTerm) ||
                                   asistencia.celular.toLowerCase().includes(searchTerm);
            return cumpleFiltro && cumpleBusqueda;
        });
    }

    mostrarAsistencias(asistenciasFiltradas);
}

        // Funciones para manejar la lista de personas (actualizada)
        async function cargarPersonas() {
            if (!verificarSesion()) return;
            try {
                const usuario = JSON.parse(localStorage.getItem('user'));
                const response = await fetch('https://localhost:7016/api/Personas/ObtenerListaDePersonas', {
                    headers: {
                        'UserId': usuario.id,
                        'Username': usuario.username
                    }
                });
                if (response.ok) {
                    const personas = await response.json();
                    const listaHTML = personas.map(persona => `
                        <div class="bg-white p-4 rounded-lg shadow flex flex-col sm:flex-row justify-between items-start sm:items-center persona">
                            <div class="mb-2 sm:mb-0">
                                <h3 class="font-semibold">${persona.nombreCompleto} - ${persona.registro}</h3>
                                <p>${persona.correo} - ${persona.celular} - ${persona.carrera}</p>
                                
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="editarPersona(${persona.id})" class="bg-yellow-500 text-white py-1 px-2 rounded hover:bg-yellow-600 transition duration-200">Editar</button>
                                <button onclick="eliminarPersona(${persona.id})" class="bg-red-500 text-white py-1 px-2 rounded hover:bg-red-600 transition duration-200">Eliminar</button>
                                <button onclick="reenviarQR(${persona.id})" class="bg-green-500 text-white py-1 px-2 rounded hover:bg-green-600 transition duration-200">Reenviar QR</button>
                                <button onclick="mostrarQR(${persona.id})" class="bg-blue-500 text-white py-1 px-2 rounded hover:bg-blue-600 transition duration-200">Mostrar QR</button>
                                <button onclick="subirCertificado(${persona.id})" class="bg-purple-500 text-white py-1 px-2 rounded hover:bg-purple-600 transition duration-200">Subir certificado</button>
                                <button onclick="verCertificado(${persona.id})" class="bg-orange-500 text-white py-1 px-2 rounded hover:bg-orange-600 transition duration-200">Ver Certificado</button>
                                </div>
                        </div>
                    `).join('');
                    document.getElementById('personasList').innerHTML = listaHTML;

                } else if (response.status === 401) {
                    alert('Sesión no válida. Por favor, inicie sesión nuevamente.');
                    localStorage.removeItem('user');
                    window.location.href = '/index.html';
                } else {
                    console.error('Error al cargar personas');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        function verCertificado(id) {
    showLoading();
    fetch(`https://localhost:7016/api/Certificado/ObtenerCertificadoPorPersonaId?idPersona=${id}`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data && data.contenido) {
                document.getElementById('certNombrePersona').textContent = data.nombreCompleto || 'No disponible';
                document.getElementById('certNombreArchivo').textContent = data.nombreArchivo || 'No disponible';
                document.getElementById('certExtension').textContent = data.extension || 'No disponible';
                
                // Crear un Blob con el contenido del PDF
                const blob = base64toBlob(data.contenido, 'application/pdf');
                const blobUrl = URL.createObjectURL(blob);
                
                // Mostrar el PDF en un iframe
                const previewElement = document.getElementById('certificadoPreview');
                previewElement.innerHTML = `<iframe src="${blobUrl}" width="100%" height="100%" style="border: none;"></iframe>`;

                // Configurar el botón de descarga
                const descargarBtn = document.getElementById('descargarCertificadoBtn');
                descargarBtn.onclick = () => descargarCertificado(blob, data.nombreArchivo || 'certificado.pdf');

                document.getElementById('certificadoModal').classList.remove('hidden');
            } else {
                showAlert('Error', 'No se encontró el contenido del certificado', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error al obtener el certificado:', error);
            showAlert('Error', 'Hubo un problema al obtener el certificado', 'error');
        });
}

// Función auxiliar para convertir base64 a Blob
function base64toBlob(base64, mimeType) {
    const byteCharacters = atob(base64);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    return new Blob([byteArray], {type: mimeType});
}
function descargarCertificado(blob, nombreArchivo) {
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = nombreArchivo;
    link.click();
    URL.revokeObjectURL(link.href);
}
// Función para mostrar el QR
async function mostrarQR(id) {
    try {
        const [qrResponse, personaResponse] = await Promise.all([
            fetch(`https://localhost:7016/api/Personas/VerQR?id=${id}`),
            fetch(`https://localhost:7016/api/Personas/ObtenerPersonaPorId?id=${id}`)
        ]);

        if (qrResponse.ok && personaResponse.ok) {
            const qrData = await qrResponse.json();
            const persona = await personaResponse.json();
            
            const qrContainer = document.getElementById('qrContainer');
            qrContainer.innerHTML = `
                <img src="data:image/png;base64,${qrData.base64String}" alt="Código QR" id="qrImage">
                <button onclick="descargarQR('${persona.nombreCompleto}', '${persona.celular}')" class="bg-green-500 text-white py-2 px-4 rounded mt-4 hover:bg-green-600 transition duration-200">Descargar QR</button>
            `;
            document.getElementById('qrModal').classList.remove('hidden');
        } else {
            console.error('Error al obtener QR o información de la persona');
        }
    } catch (error) {
        console.error('Error:', error);
    } 
}
async function enviarCertificadosATodos() {
    showLoading();
    try {
        const response = await fetch('https://localhost:7016/api/Personas/ObtenerListaDePersonas');
        if (!response.ok) {
            showAlert('Error', 'No se pudo obtener la lista de personas', 'error');
            hideLoading();
            return;
        }

        const personas = await response.json();
        const certificados = await Promise.all(personas.map(async (persona) => {
            // Llamar a la API para obtener el contenido del certificado
            const certResponse = await fetch(`https://localhost:7016/api/Certificado/ObtenerCertificadoPorPersonaId?idPersona=${persona.id}`);
            if (certResponse.ok) {
                const certData = await certResponse.json();
                return {
                    idPersona: persona.id,
                    correo: persona.correo,
                    contenido: certData.contenido // Asegúrate de que el contenido sea un string en base64
                };
            }
        }));

        // Filtrar los certificados válidos
        const certificadosValidos = certificados.filter(cert => cert !== undefined);

        const sendResponse = await fetch('https://localhost:7016/api/Certificado/EnviarCertificadoATodos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(certificadosValidos)
        });

        hideLoading();
        if (sendResponse.ok) {
            showAlert('Éxito', 'Certificados enviados a todos los usuarios.', 'success');
        } else {
            showAlert('Error', 'No se pudieron enviar los certificados a todos.', 'error');
        }
    } catch (error) {
        hideLoading();
        console.error('Error al enviar certificados:', error);
        showAlert('Error', 'Hubo un problema al enviar los certificados.', 'error');
    }
}

// Función para enviar QRs a todos
async function enviarQRsATodos() {
    showLoading();
    try {
        const response = await fetch('https://localhost:7016/api/Personas/ObtenerListaDePersonas');
        if (!response.ok) {
            showAlert('Error', 'No se pudo obtener la lista de personas', 'error');
            hideLoading();
            return;
        }

        const personas = await response.json();
        const qrs = await Promise.all(personas.map(async (persona) => {
            // Llamar a la API para obtener el QR
            const qrResponse = await fetch(`https://localhost:7016/api/Personas/VerQR?id=${persona.id}`);
            if (qrResponse.ok) {
                const qrData = await qrResponse.json();
                return {
                    idPersona: persona.id,
                    correo: persona.correo,
                    base64string: qrData.base64String // Asegúrate de que el base64String sea el correcto
                };
            }
        }));

        // Filtrar los QRs válidos
        const qrsValidos = qrs.filter(qr => qr !== undefined);

        const sendResponse = await fetch('https://localhost:7016/api/QR/EnviarQRATodasLasPersonas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(qrsValidos)
        });

        hideLoading();
        if (sendResponse.ok) {
            showAlert('Éxito', 'QRs enviados a todos los usuarios.', 'success');
        } else {
            showAlert('Error', 'No se pudieron enviar los QRs a todos.', 'error');
        }
    } catch (error) {
        hideLoading();
        console.error('Error al enviar QRs:', error);
        showAlert('Error', 'Hubo un problema al enviar los QRs.', 'error');
    }
}
document.getElementById('enviarCertificadoTodos').addEventListener('click', enviarCertificadosATodos);
document.getElementById('enviarQRTodos').addEventListener('click', enviarQRsATodos);

function descargarQR(nombreCompleto, celular) {
    const img = document.getElementById('qrImage');
    const canvas = document.createElement('canvas');
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, img.width, img.height);
    
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    
    // Limpiar el nombre del archivo
    const nombreLimpio = limpiarNombreArchivo(nombreCompleto);
    const celularLimpio = limpiarNombreArchivo(celular);
    a.download = `${nombreLimpio}-${celularLimpio}-codigo_qr.png`;
    
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function limpiarNombreArchivo(str) {
    return str.replace(/[^a-z0-9]/gi, '_').toLowerCase();
}
function cerrarModalQR() {
    document.getElementById('qrModal').classList.add('hidden');
}
function cerrarModalCertificado() {
    document.getElementById('certificadoModal').classList.add('hidden');
}
async function registrarAsistencia(personaId) {
    try {
        showLoading();
        const fechaActual = getCurrentDateTime();
        const fechaFormateada = encodeURIComponent(fechaActual);
        const response = await fetch(`https://localhost:7016/api/Asistencia/RegistrarAsistencia?idPersona=${personaId}&Fecha=${fechaFormateada}`, {
            method: 'POST',
        });
        console.log(response);

        hideLoading();
        
        if (response.ok) {
            showAlert('Éxito', 'Asistencia registrada correctamente', 'success');
            closeQRScanner();
            cargarAsistencias();
        } else {
            showAlert('Error', 'No se pudo registrar la asistencia', 'error');
        }
    } catch (error) {
        hideLoading();
        console.error('Error al registrar asistencia:', error);
        showAlert('Error', 'Hubo un problema al registrar la asistencia', 'error');
    }
}
async function guardarPersona(event) {
    event.preventDefault(); // Prevenir el comportamiento por defecto del formulario
    const personaId = document.getElementById('personaId').value;
    const persona = {
        id: personaId,
        nombreCompleto: document.getElementById('nombreCompleto').value,
        correo: document.getElementById('correo').value,
        celular: document.getElementById('celular').value,
        carrera: document.getElementById('carrera').value,
        registro: document.getElementById('registro').value
    };

    const url = personaId ? 'https://localhost:7016/api/Personas/ActualizarPersona' : 'https://localhost:7016/api/Personas/GuardarPersona';
    const method = personaId ? 'PATCH' : 'POST';

    try {
        showLoading();
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(persona)
        });

        hideLoading();
        if (response.ok) {
            showAlert('Éxito', 'Persona guardada correctamente', 'success');
            cerrarModal();
            await cargarPersonas();
        } else {
            showAlert('Error', 'No se pudo guardar la persona', 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert('Error', 'Hubo un problema al conectar con el servidor', 'error');
    }
}
async function guardarPersonaYEnviarCorreo(event) {
    event.preventDefault(); // Prevenir el comportamiento por defecto del formulario
    const persona = {
        nombreCompleto: document.getElementById('nombreCompleto').value,
        correo: document.getElementById('correo').value,
        celular: document.getElementById('celular').value,
        carrera: document.getElementById('carrera').value,
        registro: document.getElementById('registro').value
    };

    try {
        showLoading();
        const response = await fetch('https://localhost:7016/api/Personas/GuardarPersonaYEnviarQR', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(persona)
        });

        hideLoading();
        if (response.ok) {
            showAlert('Éxito', 'Persona guardada y correo enviado correctamente', 'success');
            cerrarModal();
            await cargarPersonas();
        } else {
            showAlert('Error', 'No se pudo guardar la persona o enviar el correo', 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert('Error', 'Hubo un problema al conectar con el servidor', 'error');
    }
}

// Función para abrir el modal de agregar/editar persona
function abrirModal(isEditing = false) {
    const modal = document.getElementById('personaModal');
    const form = document.getElementById('personaForm');
    const title = document.getElementById('modalTitle');
    const guardarBtn = document.getElementById('guardarBtn');
    const guardarEnviarBtn = document.getElementById('guardarEnviarBtn');

    if (isEditing) {
        title.textContent = 'Editar Persona';
        guardarEnviarBtn.classList.add('hidden');
        guardarBtn.classList.remove('hidden');
    } else {
        title.textContent = 'Agregar Persona';
        form.reset();
        document.getElementById('personaId').value = '';
        guardarEnviarBtn.classList.remove('hidden');
        guardarBtn.classList.add('hidden');
    }

    modal.classList.remove('hidden');
}

document.getElementById('addPersonaBtn').addEventListener('click', () => abrirModal(false));
async function editarPersona(id) {
    showLoading();
    try {
        const response = await fetch(`https://localhost:7016/api/Personas/ObtenerPersonaPorId?id=${id}`);
        hideLoading();
        if (response.ok) {
            const persona = await response.json();
            document.getElementById('personaId').value = persona.id;
            document.getElementById('nombreCompleto').value = persona.nombreCompleto;
            document.getElementById('correo').value = persona.correo;
            document.getElementById('celular').value = persona.celular;
            document.getElementById('carrera').value = persona.carrera;
            document.getElementById('registro').value = persona.registro;
            abrirModal(true);
        } else {
            showAlert('Error', 'No se pudo obtener la información de la persona', 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert('Error', 'Hubo un problema al conectar con el servidor', 'error');
    }
}
async function eliminarPersona(id) {
            const result = await Swal.fire({
                title: '¿Está seguro?',
                text: "Esta acción no se puede deshacer",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            });

            if (result.isConfirmed) {
                showLoading();
                try {
                    const response = await fetch(`https://localhost:7016/api/Personas/EliminarPersona?id=${id}`, { method: 'DELETE' });
                    hideLoading();
                    if (response.ok) {
                        showAlert('Eliminado', 'La persona ha sido eliminada correctamente', 'success');
                        await cargarPersonas();
                    } else {
                        showAlert('Error', 'No se pudo eliminar la persona', 'error');
                    }
                } catch (error) {
                    hideLoading();
                    showAlert('Error', 'Hubo un problema al conectar con el servidor', 'error');
                }
            }
        }

        async function reenviarQR(id) {
            showLoading();
            try {
                const response = await fetch(`https://localhost:7016/api/Personas/ReenviarQR?id=${id}`, { method: 'POST' });
                hideLoading();
                if (response.ok) {
                    showAlert('Éxito', 'QR reenviado exitosamente', 'success');
                } else {
                    showAlert('Error', 'No se pudo reenviar el QR', 'error');
                }
            } catch (error) {
                hideLoading();
                showAlert('Error', 'Hubo un problema al conectar con el servidor', 'error');
            }
        }
async function cargarUsuarios() {
            if (!verificarSesion()) return;
            try {
                const usuario = JSON.parse(localStorage.getItem('user'));
                const response = await fetch('https://localhost:7016/api/Usuarios/ObtenerListaDeUsuarios', {
                    headers: {
                        'UserId': usuario.id,
                        'Username': usuario.username
                    }
                });
                if (response.ok) {
                    const usuarios = await response.json();
                    const listaHTML = usuarios.map(usuario => `
                        <div class="bg-white p-4 rounded-lg shadow flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="mb-2 sm:mb-0">
                                <h3 class="font-semibold">${usuario.username}</h3>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editarUsuario(${usuario.id})" class="bg-yellow-500 text-white py-1 px-2 rounded hover:bg-yellow-600 transition duration-200">Editar</button>
                                <button onclick="eliminarUsuario(${usuario.id})" class="bg-red-500 text-white py-1 px-2 rounded hover:bg-red-600 transition duration-200">Eliminar</button>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('usuariosList').innerHTML = listaHTML;
                } else if (response.status === 401) {
                    alert('Sesión no válida. Por favor, inicie sesión nuevamente.');
                    localStorage.removeItem('user');
                    window.location.href = '/index.html';
                } else {
                    console.error('Error al cargar usuarios');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        async function guardarUsuario(event) {
    event.preventDefault();
    showLoading();
    const usuarioId = document.getElementById('usuarioId').value;
    const usuario = {
        id: usuarioId,
        username: document.getElementById('username').value,
        password: document.getElementById('password').value
    };

    try {
        let url, method;
        if (usuarioId) {
            url = 'https://localhost:7016/api/Usuarios/EditarUsuario';
            method = 'PATCH';
        } else {
            url = 'https://localhost:7016/api/Usuarios/CrearUsuario';
            method = 'POST';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(usuario)
        });

        hideLoading();
        if (response.ok) {
            showAlert('Éxito', 'Usuario guardado correctamente', 'success');
            cerrarModalUsuario();
            cargarUsuarios();
        } else {
            showAlert('Error', 'No se pudo guardar el usuario', 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert('Error', 'Hubo un problema al conectar con el servidor', 'error');
    } 
}
async function editarUsuario(id) {
    showLoading();
    try {
        const response = await fetch(`https://localhost:7016/api/Usuarios/ObtenerUsuarioPorId?id=${id}`);
        hideLoading();
        if (response.ok) {
            const usuario = await response.json();
            document.getElementById('usuarioId').value = usuario.id;
            document.getElementById('username').value = usuario.username;
            document.getElementById('password').value = ''; // Por seguridad, no mostramos la contraseña actual
            document.getElementById('usuarioModalTitle').textContent = 'Editar Usuario';
            abrirModalUsuario();
        } else {
            showAlert('Error', 'No se pudo obtener la información del usuario', 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert('Error', 'Hubo un problema al conectar con el servidor', 'error');
    }
}
async function eliminarUsuario(id) {
    const result = await Swal.fire({
        title: '¿Está seguro?',
        text: "Esta acción no se puede deshacer",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    });
    if (result.isConfirmed) {
        showLoading();
        try {
            const response = await fetch(`https://localhost:7016/api/Usuarios/EliminarUsuario?id=${id}`, { method: 'DELETE' });
            hideLoading();
            if (response.ok) {
                showAlert('Eliminado', 'El usuario ha sido eliminado correctamente', 'success');
                cargarUsuarios();
            } else {
                showAlert('Error', 'No se pudo eliminar el usuario', 'error');
            }
        } catch (error) {
            hideLoading();
            showAlert('Error', 'Hubo un problema al conectar con el servidor', 'error');
        }
    }
}
function abrirModalUsuario() {
    document.getElementById('usuarioModal').classList.remove('hidden');
}

function cerrarModalUsuario() {
    document.getElementById('usuarioModal').classList.add('hidden');
    document.getElementById('usuarioForm').reset();
    document.getElementById('usuarioId').value = '';
    document.getElementById('usuarioModalTitle').textContent = 'Agregar Usuario';
}
document.addEventListener('DOMContentLoaded', () => {
            // Remover event listeners antiguos si existen
    const guardarBtn = document.getElementById('guardarBtn');
    const guardarEnviarBtn = document.getElementById('guardarEnviarBtn');
    const addPersonaBtn = document.getElementById('addPersonaBtn');
    
    guardarBtn.removeEventListener('click', guardarPersona);
    guardarEnviarBtn.removeEventListener('click', guardarPersonaYEnviarCorreo);
    
    // Agregar nuevos event listeners
    document.getElementById('personaForm').addEventListener('submit', (event) => {
        event.preventDefault(); // Prevenir el envío del formulario
        if (!guardarBtn.classList.contains('hidden')) {
            guardarPersona(event);
        } else if (!guardarEnviarBtn.classList.contains('hidden')) {
            guardarPersonaYEnviarCorreo(event);
        }
    });
    addPersonaBtn.addEventListener('click', () => abrirModal(false));
            showLoading();
            // Simular un tiempo de carga
            setTimeout(() => {
                hideLoading();
                verificarSesion();
                cargarPersonas();
                cargarUsuarios();
                cargarAsistencias();
            }, 1000); // 1.5 segundos de "carga"
            const scanQRButton = document.getElementById('scanQRButton');
            if (scanQRButton) {
            scanQRButton.addEventListener('click', function(e) {
            e.preventDefault();
            openQRScanner();
            document.getElementById('guardarBtn').addEventListener('click', guardarPersona);
            document.getElementById('guardarEnviarBtn').addEventListener('click', guardarPersonaYEnviarCorreo);


        });
    }
        document.getElementById('asistenciaSearch').addEventListener('input', filtrarAsistencias);
        document.getElementById('filtroAsistencias').addEventListener('change', filtrarAsistencias);
        document.getElementById('guardarBtn').addEventListener('click', guardarPersona);
        document.getElementById('guardarEnviarBtn').addEventListener('click', guardarPersonaYEnviarCorreo);
        document.getElementById('cancelarBtn').addEventListener('click', cerrarModal);
        });
// Event listeners adicionales

document.getElementById('personaSearch').addEventListener('input', (e) => {
                filtrarPersonas(e.target.value);
            });
document.getElementById('usuarioSearch').addEventListener('input', (e) => {
                filtrarUsuarios(e.target.value);
            });
document.getElementById('asistenciaSearch').addEventListener('input', (e) => {
            filtrarAsistencias(e.target.value);
            });
document.getElementById('addUsuarioBtn').addEventListener('click', abrirModalUsuario);
document.getElementById('usuarioForm').addEventListener('submit', guardarUsuario);


        // Funciones para manejar el modal (sin cambios)
        function abrirModal() {
            document.getElementById('personaModal').classList.remove('hidden');
        }

        function cerrarModal() {
    document.getElementById('personaModal').classList.add('hidden');
}

        // Event listeners (sin cambios)
        document.getElementById('addPersonaBtn').addEventListener('click', () => {
            document.getElementById('modalTitle').textContent = 'Agregar Persona';
            document.getElementById('personaId').value = '';
            document.getElementById('nombreCompleto').value = '';
            document.getElementById('celular').value = '';
            document.getElementById('correo').value = '';
            document.getElementById('carrera').value = '';
            document.getElementById('registro').value = '';
            document.getElementById('personaModal').classList.remove('hidden');
        });
        
        document.getElementById('cancelarBtn').addEventListener('click', () => {
            document.getElementById('personaModal').classList.add('hidden');
        });

        document.getElementById('guardarBtn').addEventListener('click', () => {
            guardarPersona('https://localhost:7016/api/Personas/GuardarPersona');
        });

        document.getElementById('guardarEnviarBtn').addEventListener('click', () => {
            guardarPersona('https://localhost:7016/api/Personas/GuardarPersonaYEnviarQR');
        });

        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('user');
            window.location.href = '/index.html';
        });
        function verificarSesion() {
            showLoading();
            const usuario = JSON.parse(localStorage.getItem('user'));
            if (!usuario || !usuario.id || !usuario.username) {
                hideLoading();
                window.location.href = '/index.html';
                return false;
            }
            hideLoading();
            return true;
        }
        function cambiarSeccion(seccion) {
        if (seccion === 'personas') {
        cargarPersonas();
        }
        if (seccion === 'usuarios') {
        cargarUsuarios();
        }
        if(seccion === "asistencias"){
            cargarAsistencias();
        }
}
document.querySelectorAll('.sidebar-tab').forEach(tab => {
    tab.addEventListener('click', (e) => {
        const seccion = e.target.getAttribute('data-seccion');
        cambiarSeccion(seccion);
    });
});
function abrirModalRegistroAsistencia() {
    document.getElementById('registrarAsistenciaModal').classList.remove('hidden');
    personasSeleccionadas.clear(); // Limpiar selecciones al abrir
    cargarPersonasParaSelect();
}

function cerrarModalRegistroAsistencia() {
    document.getElementById('registrarAsistenciaModal').classList.add('hidden');
    document.getElementById('personaSearchInput').value = '';
    document.getElementById('personaSearchResults').innerHTML = '';
    personasSeleccionadas.clear();
    mostrarTodasLasPersonas(); // Esto actualizará la lista de personas sin selecciones
}

async function cargarPersonasParaSelect() {
    try {
        const response = await fetch('https://localhost:7016/api/Personas/ObtenerListaDePersonas');
        if (response.ok) {
            const personas = await response.json();
            mostrarPersonasEnModal(personas);
        } else {
            console.error('Error al cargar personas');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
function mostrarPersonasEnModal(personas) {
    const listaResultados = document.getElementById('personaSearchResults');
    listaResultados.innerHTML = personas.map(persona => `
        <li class="flex items-center hover:bg-gray-100 p-2">
            <input type="checkbox" id="persona-${persona.id}" 
                   onchange="toggleSeleccionPersona(${persona.id})">
            <label for="persona-${persona.id}" class="ml-2 cursor-pointer">${persona.nombreCompleto}</label>
        </li>
    `).join('');
}
function mostrarTodasLasPersonas() {
    mostrarResultadosBusqueda(todasLasPersonas);
}
function abrirModalRegistroAsistencia() {
    document.getElementById('registrarAsistenciaModal').classList.remove('hidden');
    cargarPersonasParaSelect();
    document.getElementById('personaSearchInput').addEventListener('input', buscarPersonas);
}
function buscarPersonas() {
    const searchTerm = document.getElementById('personaSearchInput').value.toLowerCase();
    fetch('https://localhost:7016/api/Personas/ObtenerListaDePersonas')
        .then(response => response.json())
        .then(personas => {
            const resultados = personas.filter(persona => 
                persona.nombreCompleto.toLowerCase().includes(searchTerm)
            );
            mostrarPersonasEnModal(resultados);
        })
        .catch(error => console.error('Error en la búsqueda:', error));
}
document.getElementById('personaSearchInput').addEventListener('input', buscarPersonas);
let personaSeleccionadaId = null;

function seleccionarPersona(id, nombre) {
    personaSeleccionadaId = id;
    document.getElementById('personaSearchInput').value = nombre;
    // Mantener la lista visible, pero resaltar la selección
    mostrarResultadosBusqueda(todasLasPersonas);
    resaltarSeleccion(id);
}
function resaltarSeleccion(id) {
    const items = document.querySelectorAll('#personaSearchResults li');
    items.forEach(item => {
        if (item.onclick.toString().includes(`seleccionarPersona(${id}`)) {
            item.classList.add('bg-blue-100');
        } else {
            item.classList.remove('bg-blue-100');
        }
    });
}
function mostrarResultadosBusqueda(resultados) {
    const listaResultados = document.getElementById('personaSearchResults');
    listaResultados.innerHTML = resultados.map(persona => `
        <li class="flex items-center hover:bg-gray-100 p-2">
            <input type="checkbox" id="persona-${persona.id}" 
                   ${personasSeleccionadas.has(persona.id) ? 'checked' : ''}
                   onchange="toggleSeleccionPersona(${persona.id}, '${persona.nombreCompleto}')">
            <label for="persona-${persona.id}" class="ml-2 cursor-pointer">${persona.nombreCompleto}</label>
        </li>
    `).join('');
}
function toggleSeleccionPersona(id) {
    if (personasSeleccionadas.has(id)) {
        personasSeleccionadas.delete(id);
    } else {
        personasSeleccionadas.add(id);
    }
}
async function registrarAsistenciasMultiples() {
    if (personasSeleccionadas.size === 0) {
        showAlert('Error', 'Por favor, seleccione al menos una persona', 'error');
        return;
    }

    const fechaActual = getCurrentDateTime();
    const asistencias = Array.from(personasSeleccionadas).map(id => ({
        idPersona: id,
        fecha: fechaActual
    }));

    try {
        const response = await fetch('https://localhost:7016/api/Asistencia/RegistrarMultiplesAsistencias', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(asistencias)
        });

        if (response.ok) {
            showAlert('Éxito', 'Asistencias registradas correctamente', 'success');
            cerrarModalRegistroAsistencia();
            cargarAsistencias();
        } else {
            showAlert('Error', 'No se pudieron registrar las asistencias', 'error');
        }
    } catch (error) {
        console.error('Error al registrar asistencias:', error);
        showAlert('Error', 'Hubo un problema al registrar las asistencias', 'error');
    }
}
function cerrarModalRegistroAsistencia() {
    document.getElementById('registrarAsistenciaModal').classList.add('hidden');
    document.getElementById('personaSearchInput').value = '';
    document.getElementById('personaSearchResults').innerHTML = '';
    personasSeleccionadas.clear();
}
async function registrarAsistenciaManual() {
    if (!personaSeleccionadaId) {
        showAlert('Error', 'Por favor, seleccione una persona', 'error');
        return;
    }

    const fechaActual = getCurrentDateTime();
    const fechaFormateada = encodeURIComponent(fechaActual);

    try {
        const response = await fetch(`https://localhost:7016/api/Asistencia/RegistrarAsistencia?idPersona=${personaSeleccionadaId}&Fecha=${fechaFormateada}`, {
            method: 'POST',
        });
        if (response.ok) {
            showAlert('Éxito', 'Asistencia registrada correctamente', 'success');
            cerrarModalRegistroAsistencia();
            cargarAsistencias();
        } else {
            showAlert('Error', 'No se pudo registrar la asistencia', 'error');
        }
    } catch (error) {
        console.error('Error al registrar asistencia:', error);
        showAlert('Error', 'Hubo un problema al registrar la asistencia', 'error');
    }
}
function cerrarModalRegistroAsistencia() {
    document.getElementById('registrarAsistenciaModal').classList.add('hidden');
    document.getElementById('personaSearchInput').value = '';
    document.getElementById('personaSearchResults').innerHTML = '';
    personaSeleccionadaId = null;
}
document.getElementById('registrarAsistenciaManual').addEventListener('click', abrirModalRegistroAsistencia);

function convertirAExcel() {
    const table = document.getElementById('asistenciasList');
    
    // Extraer los datos de la tabla
    const data = Array.from(table.querySelectorAll('tr')).map(row => {
        // Filtrar las celdas que no contienen botones
        const cells = Array.from(row.querySelectorAll('td')).filter(cell => !cell.querySelector('button'));
        return cells.map(cell => cell.textContent.trim());
    });

    // Definir los nuevos encabezados
    const headers = ['Nombre Completo', 'Registro', 'Correo', 'Carrera', 'Celular', 'Fecha/Hora de Asistencia'];

    // Crear una hoja de cálculo con los encabezados
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]); // Usa data para incluir todas las filas

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Asistencias");

    // Ajustar el ancho de las columnas para que los datos sean legibles
    const colWidths = headers.map(h => ({wch: h.length + 5})); // +5 para un poco de padding
    ws['!cols'] = colWidths;

    // Generar y descargar el archivo Excel
    XLSX.writeFile(wb, "Asistencias.xlsx");
}
function generarExcelPersonas() {
    const personasList = document.getElementById('personasList');
    
    // Extraer los datos de los divs que representan personas
    const data = Array.from(personasList.querySelectorAll('.persona')).map(personaDiv => {
        // Extraer el texto del nombre completo, registro, correo, celular, y carrera
        const nombreCompletoYRegistro = personaDiv.querySelector('h3').textContent.split(' - ');
        const nombreCompleto = nombreCompletoYRegistro[0];
        const registro = nombreCompletoYRegistro[1];
        
        const detalles = personaDiv.querySelector('p').textContent.split(' - ');
        const correo = detalles[0];
        const celular = detalles[1];
        const carrera = detalles[2];

        return [nombreCompleto, registro, correo, celular, carrera];
    });

    // Definir los encabezados
    const headers = ['Nombre Completo', 'Registro', 'Correo', 'Celular', 'Carrera'];

    // Crear una hoja de cálculo con los encabezados
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Personas");

    // Ajustar el ancho de las columnas para que los datos sean legibles
    const colWidths = headers.map(h => ({wch: h.length + 5})); // +5 para un poco de padding
    ws['!cols'] = colWidths;

    // Generar y descargar el archivo Excel
    XLSX.writeFile(wb, "Personas.xlsx");
}

document.getElementById('generarExcelPersonas').addEventListener('click', generarExcelPersonas);
document.getElementById('convertirExcel').addEventListener('click', convertirAExcel);
    </script>
</body>
</html>